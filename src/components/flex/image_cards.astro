---
import { fetchFlexText } from "../../lib/wp/pullFlexText";

export type PullFrom = {
  objectType: "post" | "term";
  objectId?: number;
  taxonomy?: string;
  field?: string;
  selector?: string;
  rowIndex?: number;
  moduleClass?: string;
  debug?: boolean; // NEW
};

interface Props {
  postId?: number | null;
  currentPost?: any;
  termId?: number | null;
  taxonomy?: string | null;
  section_id?: string;
  wrapperClasses?: string;
  geo_keyword?: string;
  rowIndex?: number;
}

const {
  postId = null,
  currentPost = null,
  termId = null,
  taxonomy = null,
  section_id = "",
  wrapperClasses = "",
  geo_keyword = "",
  rowIndex = Astro.props.rowIndex as number | undefined,
} = Astro.props as Props;

let pulledHtml = "";
let pullDebug: any = null;

console.log(Astro.props);
let effectivePull: PullFrom | null = null;
if (termId && taxonomy) {
  effectivePull = {
    objectType: "term",
    objectId: termId,
    taxonomy: String(taxonomy),
    field: "flex_text",
    rowIndex,
    // OPTIONAL: if you know the WP module class for this section:
    // moduleClass: "image_cards",
    debug: true, // turn on per-call logging
  };
} else if (postId) {
  effectivePull = {
    objectType: "post",
    objectId: postId,
    field: "flex_text",
    rowIndex,
    // moduleClass: "image_cards",
    debug: true,
  };
}

if (effectivePull) {
  const pulled = await fetchFlexText(effectivePull);
  pulledHtml = pulled?.html || "";
  pullDebug = pulled || {};

  // Server-side console logs for deep dive:
  console.log("[image_cards] pull result:", {
    mode: effectivePull.objectType,
    taxonomy: effectivePull.taxonomy || null,
    objectId: effectivePull.objectId ?? null,
    status: pulled?.status,
    url: pulled?.url,
    error: pulled?.error,
    peek: pulled?.peek,
    htmlLen: (pulled?.html || "").length,
  });

  // Print structural snapshots coming back from fetchFlexText
  if (pulled?.raw?.__debug?.snapshots) {
    console.log("[image_cards] snapshots:", pulled.raw.__debug.snapshots);
  } else {
    console.log("[image_cards] (no snapshots in response)");
  }
} else {
  console.warn("[image_cards] No valid pull context (need postId OR {termId,taxonomy}).", {
    postId,
    termId,
    taxonomy,
  });
}
---
{pulledHtml ? (
  <Fragment set:html={pulledHtml} />
) : (
  <section id={section_id} class={wrapperClasses} data-geo={geo_keyword}>
    <div>No pulled HTML â€“ render local here.</div>

    {/* Visible debug panel for live Netlify troubleshooting */}
    <div style="margin-top:1rem; padding:1rem; border:1px dashed #c33; background:#fff3f3; font-family:monospace; font-size:.9rem;">
      <div><strong>WP_BASE_URL:</strong> {import.meta.env.WP_BASE_URL || "(not set)"} </div>
      <div><strong>mode:</strong> {termId && taxonomy ? "taxonomy" : postId ? "page" : "none"} </div>
      <div><strong>taxonomy:</strong> {String(taxonomy ?? "")}</div>
      <div><strong>termId:</strong> {String(termId ?? "")}</div>
      <div><strong>postId:</strong> {String(postId ?? "")}</div>
      <div><strong>rowIndex:</strong> {String(rowIndex ?? "")}</div>
      {pullDebug && (
        <details open>
          <summary><strong>Pull Debug</strong></summary>
          <div><strong>status:</strong> {String(pullDebug.status ?? "")}</div>
          <div><strong>url:</strong> {String(pullDebug.url ?? "")}</div>
          <div><strong>error:</strong> {String(pullDebug.error ?? "")}</div>
          <div><strong>peek:</strong> {String(pullDebug.peek ?? "").slice(0, 300)}</div>
          <div><strong>raw keys:</strong> {pullDebug.raw ? Object.keys(pullDebug.raw).join(", ") : "(none)"} </div>
          {pullDebug.raw?.__debug?.snapshots && (
            <pre style="white-space:pre-wrap; max-height:24rem; overflow:auto;">
{JSON.stringify(pullDebug.raw.__debug.snapshots, null, 2)}
            </pre>
          )}
        </details>
      )}
    </div>
  </section>
)}
