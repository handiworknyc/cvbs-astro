---
import { ViewTransitions } from "astro:transitions";
import SiteNav from "../components/SiteNav.astro";
import SiteFooter from "../components/SiteFooter.astro";
import { navQuery } from "../lib/api";

// Critical CSS
import "../styles/global.scss";

// Below-the-fold CSS (built asset url)
import belowCssUrl from "@/styles/below.scss?url";

// Fetch WordPress nav & settings
const { menus, generalSettings } = await navQuery();
const primaryMenu = menus.nodes?.[0];

// ENV + derived URLs
const WP_BASE_URL = import.meta.env.WP_BASE_URL;
const MAP1_URL = `${WP_BASE_URL}/wp-content/uploads/2025/09/map-1.png`;

// Page meta from props
const { title = "", description = "" } = Astro.props;

// Compose safe title
const pageTitle = title
  ? `${title} | ${generalSettings?.title ?? ""}`
  : generalSettings?.title ?? "";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    {description && <meta name="description" content={description} />}

    <!-- Global CSS vars from env (safe injection) -->
    <style is:global define:vars={{ wpBaseUrl: `url('${WP_BASE_URL}')`, map1Url: `url('${MAP1_URL}')` }}>
      :root {
        --wp-base-url: var(--wpBaseUrl);
        --map1-url: var(--map1Url);
      }
    </style>

    <!-- Preload + lazy apply below-the-fold CSS -->
    <link rel="preload" href={belowCssUrl} as="style" />
    <link rel="stylesheet" href={belowCssUrl} media="print" onload="this.media='all'" />


    <!-- Other global/feature scripts -->
    <script type="module" src="/src/scripts/smartimage.ts"></script>
    <script is:global src="/src/scripts/header-critical.js"></script>
    <script type="module" is:global src="/src/scripts/gsap-global.ts"></script>
    <script type="module" is:global src="/src/scripts/plugins/nativebootstrap.js"></script>
    <script type="module" is:global src="/src/scripts/nav-collapse.js"></script>
  </head>

  <body>
    <ViewTransitions />

    <main>
      <SiteNav menu={primaryMenu} generalSettings={generalSettings} />
      <hr />
      <slot />
    </main>

    <SiteFooter />
    
    <!-- Feature scripts that can wait until after content -->
    <script type="module" is:global>
      import "/src/scripts/plugins/flickity.js";
      import "/src/scripts/theme.js";
      import "/src/scripts/flickitys.js";
    </script>
  </body>
</html>
