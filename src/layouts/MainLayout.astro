---
import { ViewTransitions } from "astro:transitions";
import SiteNav from "../components/SiteNav.astro";
import SiteFooter from "../components/SiteFooter.astro";
import { navQuery } from "../lib/api";

// Critical CSS
import "../styles/global.scss";

// Below-the-fold CSS (built asset url)
import belowCssUrl from "@/styles/below.scss?url";

// âœ… bundle your JS files into built URLs
import headerCriticalUrl from "@/scripts/header-critical.js?url";

import gsapGlobalUrl from "@/scripts/gsap-global.ts?url";
import nativebootstrapUrl from "@/scripts/plugins/nativebootstrap.js?url";
import navCollapseUrl from "@/scripts/nav-collapse.js?url";
import flickityUrl from "@/scripts/plugins/flickity.js?url";
import themeUrl from "@/scripts/theme.js?url";
import flickitysUrl from "@/scripts/flickitys.js?url";

Astro.response.headers.set(
  "Netlify-CDN-Cache-Control",
  "public, durable, max-age=600, stale-while-revalidate=86400"
);

Astro.response.headers.set(
  "CDN-Cache-Control",
  "public, durable, max-age=600, stale-while-revalidate=86400"
);

// Fetch WordPress nav & settings
const { menus, generalSettings } = await navQuery();
const primaryMenu = menus.nodes?.[0];

// ENV + derived URLs
const WP_BASE_URL = import.meta.env.WP_BASE_URL;
const MAP1_URL = `${WP_BASE_URL}/wp-content/uploads/2025/09/map-1.png`;

// Page meta from props
const { title = "", description = "" } = Astro.props;

// Compose safe title
const pageTitle = title
  ? `${title} | ${generalSettings?.title ?? ""}`
  : (generalSettings?.title ?? "");
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    {description && <meta name="description" content={description} />}

    <!-- Global CSS vars from env (safe injection) -->
    <style
      is:global
      define:vars={{
        wpBaseUrl: `url('${WP_BASE_URL}')`,
        map1Url: `url('${MAP1_URL}')`,
      }}
    >
      :root {
        --wp-base-url: var(--wpBaseUrl);
        --map1-url: var(--map1Url);
      }
    </style>

    <!-- Preload + lazy apply below-the-fold CSS -->
    <link rel="preload" href={belowCssUrl} as="style" />
    <link
      rel="stylesheet"
      href={belowCssUrl}
      media="print"
      onload="this.media='all'"
    />

    <!-- Critical head script, bundled -->
    <script id="header-crit" src={headerCriticalUrl}></script>

    <!-- Other global/feature scripts (bundled via ?url) -->
    <script>
      import "../scripts/smart-image";
      import "../scripts/gsap-global";
      import "../scripts/nav-collapse";
      import "../scripts/plugins/nativebootstrap";
    </script>
  </head>

  <body>
    <ViewTransitions />

    <main>
      <SiteNav menu={primaryMenu} generalSettings={generalSettings} />
      <hr />
      <slot />
    </main>

    <SiteFooter />

    <!-- Feature scripts that can wait until after content -->
    <script>
      import "../scripts/plugins/flickity";
      import "../scripts/flickitys";
      import "../scripts/theme";
      import "../scripts/theme";
    </script>
  </body>
</html>
